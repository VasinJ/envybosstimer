<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envy - Boss Timer</title>
    
    <link rel="icon" href="images/LogoEnvy.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style id="mainStyles">
        :root {
            --bg-body: #f1f2f6; --bg-panel: #ffffff; --primary: #2c3e50; 
            --secondary: #34495e; --accent: #e67e22; --danger: #c0392b; 
            --text-main: #2f3542; --text-light: #747d8c; 
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --border-r: 16px;
        }

        body { 
            font-family: 'Kanit', sans-serif; margin: 0; padding: 0; 
            background-color: var(--bg-body); color: var(--text-main); 
            height: 100vh; display: flex; overflow: hidden; zoom: 0.9;
        }

        .container { display: flex; width: 100%; height: 100%; }
        /* ‡∏õ‡∏£‡∏±‡∏ö padding ‡πÉ‡∏´‡πâ responsive */
        .left-panel, .right-panel { padding: 20px; overflow-y: auto; box-sizing: border-box; }
        
        .left-panel { width: 40%; background-color: var(--bg-panel); display: flex; flex-direction: column; gap: 15px; box-shadow: 4px 0 20px rgba(0,0,0,0.05); z-index: 10; }
        .right-panel { width: 60%; background-color: var(--bg-body); position: relative; }

        .header-container { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        h2 { margin: 0; color: var(--primary); font-weight: 700; font-size: 1.6em; }
        
        .share-section { background: #dfe4ea; padding: 10px; text-align: center; border-radius: 12px; color: var(--secondary); font-size: 0.9em; }
        .share-link { font-weight: bold; color: var(--primary); background: #fff; padding: 4px 10px; border-radius: 6px; border: 1px dashed var(--secondary); cursor: pointer; transition: 0.2s; }
        .share-link:hover { background: var(--primary); color: white; border-style: solid; }

        .tab-container { display: flex; gap: 8px; margin-top: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; background: #dfe4ea; color: #7f8fa6; font-family: 'Kanit'; font-weight: 600; font-size: 1em; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: #fff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .search-box { padding: 12px; border-radius: 12px; border: 2px solid #dfe4ea; background: #f9f9f9; outline: none; font-size: 1em; width: 95%; }
        .search-box:focus { border-color: var(--secondary); background: #fff; }

        /* Grid ‡∏ö‡∏≠‡∏™‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
        .boss-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; padding: 5px; padding-bottom: 20px; max-height: 45vh; overflow-y: scroll; }
        .boss-item { cursor: pointer; border-radius: 12px; text-align: center; padding: 8px; background: #fff; border: 2px solid #f1f2f6; transition: 0.2s; }
        .boss-item:hover, .boss-item.selected { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .boss-item.selected { background-color: #ecf0f1; }
        .boss-item img { width: 100%; height: auto; max-width: 100px; aspect-ratio: 1/1; object-fit: contain; margin-bottom: 5px; }
        .boss-item span { display: block; font-size: 0.9em; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .boss-type-badge { font-size: 0.75em; padding: 3px 8px; border-radius: 4px; display: inline-block; font-weight: 700; text-transform: uppercase; color: #fff; }
        .type-MVP { background-color: var(--danger); }
        .type-Mini { background-color: #2980b9; }
        .grid-badge { margin-bottom: 4px; font-size: 0.7em; }

        /* Input ‡πÄ‡∏ß‡∏•‡∏≤ */
        .time-inputs { display: flex; gap: 8px; justify-content: center; background: #fff; padding: 15px; border-radius: 16px; border: 1px solid #dfe4ea; margin-top: auto; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { margin-top: 5px; font-size: 0.7em; font-weight: 700; color: var(--text-light); }
        .input-group input { width: 50px; height: 50px; text-align: center; background: #f1f2f6; border: 2px solid #dfe4ea; border-radius: 10px; font-size: 1.5em; font-weight: bold; outline: none; transition: 0.3s; color: var(--primary); }
        .input-group input:focus { border-color: var(--primary); background: #fff; }
        .time-separator { font-size: 1.5em; font-weight: bold; color: #ced6e0; margin-top: 10px; }

        .btn-save { background-color: var(--primary); color: white; border: none; padding: 15px; font-size: 1.2em; font-weight: 600; cursor: pointer; border-radius: 12px; margin-top: 10px; transition: 0.2s; width: 100%; }
        .btn-save:hover { background-color: #34495e; }

        .footer-credit { margin-top: 20px; text-align: center; font-size: 0.8em; color: var(--text-light); }
        .guild-link { color: var(--danger); font-weight: bold; text-decoration: none; }

        /* üî• Main Timer Card (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô) üî• */
        .timer-card { 
            background: #fff; margin-bottom: 15px; padding: 15px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: var(--shadow); border-left: 8px solid var(--primary); 
            transition: all 0.2s;
            flex-wrap: wrap; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏Å‡∏•‡∏á‡∏°‡∏≤‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
        }
        
        .timer-info { display: flex; align-items: center; gap: 15px; flex: 1; min-width: 200px; }
        
        /* üî• ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≠ (Responsive) üî• */
        .timer-info img { 
            width: 140px; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            max-width: 25vw; /* ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 25% ‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ */
            height: auto; 
            aspect-ratio: 1/1;
            object-fit: contain; 
            border-radius: 12px; border: 1px solid #dfe4ea; background: #f8f9fa; 
        }
        
        .timer-text { display: flex; flex-direction: column; justify-content: center; align-items: flex-start; }
        .timer-text h3 { margin: 0; font-size: clamp(1.2em, 2vw, 1.8em); color: var(--primary); line-height: 1.2; } /* Font size ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô */
        .card-badge { margin-bottom: 8px; font-size: 0.8em; }
        
        .spawn-time-text { font-size: 1em; margin-top: 5px; font-weight: 600; color: var(--secondary); }
        .spawn-time-text.expired { color: var(--danger); }
        
        .countdown { 
            font-size: clamp(1.8em, 3vw, 2.5em); /* Font size ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô */
            font-weight: 700; color: var(--primary); 
            font-variant-numeric: tabular-nums; 
            text-align: right; margin-left: auto; padding-right: 15px;
        }
        .countdown.spawned { color: var(--danger); font-size: clamp(1.2em, 2.5vw, 1.8em); }
        
        .btn-delete { background: #ffeae9; border: none; color: var(--danger); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1em; flex-shrink: 0; }

        .btn-pip { position: absolute; top: 20px; right: 20px; background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; z-index: 100; transition: 0.2s; }
        .btn-pip:hover { transform: translateY(-2px); }
        .pip-active-msg { display: none; flex-direction: column; align-items: center; justify-content: center; height: 80%; color: var(--text-light); text-align: center; }

        /* Responsive Mobile */
        @media (max-width: 768px) { 
            .container { flex-direction: column; overflow-y: scroll; } 
            .left-panel, .right-panel { width: 100%; height: auto; } 
            .timer-info img { width: 80px; }
        }

        /* üî•üî•üî• CSS ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≠‡πÅ‡∏¢‡∏Å (PiP) - Badge ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß üî•üî•üî• */
        body.pip-mode { padding: 0 !important; zoom: 1 !important; background: var(--bg-body) !important; overflow-y: auto; }
        
        .pip-mode .timer-card {
            flex-direction: row; padding: 6px 10px; border-left-width: 4px; margin-bottom: 6px; 
            border-radius: 8px; box-shadow: none !important; border: 1px solid #dfe4ea; background: #fff; min-height: 55px;
        }
        .pip-mode .timer-info { flex-direction: row; gap: 10px; align-items: center; }
        .pip-mode .timer-info img { width: 40px; height: 40px; border-radius: 6px; border: none; max-width: none; } /* Fix size in PiP */
        .pip-mode .timer-text { align-items: flex-start; justify-content: center; }
        .pip-mode .timer-text h3 { font-size: 0.95rem; margin: 0; line-height: 1; }
        
        /* ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ä‡∏ß‡πå Badge ‡πÉ‡∏ô‡∏à‡∏≠‡πÅ‡∏¢‡∏Å */
        .pip-mode .card-badge { 
            display: inline-block; 
            font-size: 0.6em; 
            padding: 2px 5px; 
            margin-bottom: 2px; 
            border-radius: 3px;
        }
        
        .pip-mode .spawn-time-text { display: none; }
        .pip-mode .countdown { font-size: 1.4em; margin: 0 10px; }
        .pip-mode .btn-delete { width: 24px; height: 24px; font-size: 0.7em; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-panel">
        <div class="header-container">
            <img src="images/LogoEnvy.jpg" alt="Logo" class="logo-img">
            <h2>Boss Timer Online</h2>
        </div>
        <div id="roomInfo" class="share-section">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</div>
        <div class="tab-container">
            <button class="tab-btn active" id="tabMVP" onclick="switchTab('MVP')">MVP Boss</button>
            <button class="tab-btn" id="tabMini" onclick="switchTab('Mini')">Mini Boss</button>
        </div>
        <input type="text" id="searchBox" class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≠‡∏™... (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)">
        <div id="bossGrid" class="boss-grid"></div>
        <div class="time-inputs">
            <div class="input-group"><input type="text" id="inputHr" placeholder="00" inputmode="numeric" oninput="validateTimeInput(this)" onclick="this.select()" autocomplete="off"><label>HOUR</label></div>
            <div class="time-separator">:</div>
            <div class="input-group"><input type="text" id="inputMin" placeholder="00" inputmode="numeric" oninput="validateTimeInput(this)" onclick="this.select()" autocomplete="off"><label>MIN</label></div>
            <div class="time-separator">:</div>
            <div class="input-group"><input type="text" id="inputSec" placeholder="00" inputmode="numeric" oninput="validateTimeInput(this)" onclick="this.select()" autocomplete="off"><label>SEC</label></div>
        </div>
        <button class="btn-save" onclick="addTimerToCloud()">‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Start Timer)</button>
        <div class="footer-credit">
            <p>Developed by <strong>‡∏à‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢</strong></p>
            <p>Contact: <a href="https://www.facebook.com/profile.php?id=61571728319751" target="_blank" class="guild-link">ENVY Guild</a></p>
        </div>
    </div>

    <div class="right-panel" id="rightPanel">
        <button class="btn-pip" onclick="togglePictureInPicture()">üñ•Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡πÅ‡∏¢‡∏Å (Floating)</button>
        <h2 style="margin-bottom: 20px; color: var(--primary);">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏Å‡∏¥‡∏î (Sync Realtime)</h2>
        <div id="timerList"></div>
        <div id="pipActiveMsg" class="pip-active-msg">
            <h3 style="font-size: 3em;">üñ•Ô∏è</h3>
            <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏à‡∏≠‡πÅ‡∏¢‡∏Å</h3>
            <p>‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏™‡πÄ‡∏õ‡∏Ñ</p>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyC77trqUTlUf2qoY0ZIGYy4OtD6gJpXcb4",
      authDomain: "bosstimer-a82a8.firebaseapp.com",
      databaseURL: "https://bosstimer-a82a8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bosstimer-a82a8",
      storageBucket: "bosstimer-a82a8.firebasestorage.app",
      messagingSenderId: "280032313580",
      appId: "1:280032313580:web:ec3145c4ab7e8cef2b65c9",
      measurementId: "G-4XR94RRGS1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const bossData = [
        // --- MVP ---
        { id: 1, type: 'MVP', name: "Amon Ra", img: "images/MVP_Boss/MVP_Amon Ra.png" },
        { id: 2, type: 'MVP', name: "Arc Angeling", img: "images/MVP_Boss/MVP_Arc Angeling.png" },
        { id: 3, type: 'MVP', name: "Doppelganger", img: "images/MVP_Boss/MVP_Doppelganger.png" },
        { id: 4, type: 'MVP', name: "Fallen Bishop", img: "images/MVP_Boss/MVP_Fallen Bishop.png" },
        { id: 5, type: 'MVP', name: "Garm", img: "images/MVP_Boss/MVP_Garm.png" },
        { id: 6, type: 'MVP', name: "Gioia", img: "images/MVP_Boss/MVP_Gioia.png" },
        { id: 7, type: 'MVP', name: "Gloom Under Night", img: "images/MVP_Boss/MVP_Gloom Under Night.png" },
        { id: 8, type: 'MVP', name: "Kraken", img: "images/MVP_Boss/MVP_Kraken.png" },
        { id: 9, type: 'MVP', name: "Lord of the Dead", img: "images/MVP_Boss/MVP_Lord of the Dead.png" },
        { id: 10, type: 'MVP', name: "Lost Dragon", img: "images/MVP_Boss/MVP_Lost Dragon.png" },
        { id: 11, type: 'MVP', name: "Mistress", img: "images/MVP_Boss/MVP_Mistress.png" },
        { id: 12, type: 'MVP', name: "Morroc", img: "images/MVP_Boss/MVP_Morroc.png" },
        { id: 13, type: 'MVP', name: "Nidhoggrs Shadow", img: "images/MVP_Boss/MVP_Nidhoggrs Shadow.png" },
        { id: 14, type: 'MVP', name: "Orc Lord", img: "images/MVP_Boss/MVP_Orc Lord.png" },
        { id: 15, type: 'MVP', name: "Phreeoni", img: "images/MVP_Boss/MVP_Phreeoni.png" },
        { id: 16, type: 'MVP', name: "Retribution", img: "images/MVP_Boss/MVP_Retribution.png" },
        { id: 17, type: 'MVP', name: "RSX-0806", img: "images/MVP_Boss/MVP_RSX-0806.png" },
        { id: 18, type: 'MVP', name: "Shadow Chaser Gertie", img: "images/MVP_Boss/MVP_Shadow Chaser Gertie.png" },
        { id: 19, type: 'MVP', name: "Tao Gunka", img: "images/MVP_Boss/MVP_Tao Gunka.png" },
        { id: 20, type: 'MVP', name: "Time Holder", img: "images/MVP_Boss/MVP_Time Holder.png" },
        { id: 21, type: 'MVP', name: "Genetic Flamel", img: "images/MVP_Boss/MVP_Genetic Flamel.png" },
        // --- Mini Boss ---
        { id: 101, type: 'Mini', name: "Angeling", img: "images/Mini_Boss/Mini_Angeling.png" },
        { id: 102, type: 'Mini', name: "Chimera", img: "images/Mini_Boss/Mini_Chimera.png" },
        { id: 103, type: 'Mini', name: "Coelacanth", img: "images/Mini_Boss/Mini_Coelacanth.png" },
        { id: 104, type: 'Mini', name: "Dark Priest", img: "images/Mini_Boss/Mini_Dark Priest.png" },
        { id: 105, type: 'Mini', name: "Deviling", img: "images/Mini_Boss/Mini_Deviling.png" },
        { id: 106, type: 'Mini', name: "Dragon Fly", img: "images/Mini_Boss/Mini_Dragon Fly.png" },
        { id: 107, type: 'Mini', name: "Eclipse", img: "images/Mini_Boss/Mini_Eclipse.png" },
        { id: 108, type: 'Mini', name: "Faceworm Queen", img: "images/Mini_Boss/Mini_Faceworm Queen.png" },
        { id: 109, type: 'Mini', name: "Ghostring", img: "images/Mini_Boss/Mini_Ghostring.png" },
        { id: 110, type: 'Mini', name: "Gold Queen Scaraba", img: "images/Mini_Boss/Mini_Gold Queen Scaraba.png" },
        { id: 111, type: 'Mini', name: "King Dramoh", img: "images/Mini_Boss/Mini_King Dramoh.png" },
        { id: 112, type: 'Mini', name: "Mastering", img: "images/Mini_Boss/Mini_Mastering.png" },
        { id: 113, type: 'Mini', name: "Mysteltainn", img: "images/Mini_Boss/Mini_Mysteltainn.png" },
        { id: 114, type: 'Mini', name: "Naght Sieger", img: "images/Mini_Boss/Mini_Naght Sieger.png" },
        { id: 115, type: 'Mini', name: "Necromancer", img: "images/Mini_Boss/Mini_Necromancer.png" },
        { id: 116, type: 'Mini', name: "Observation", img: "images/Mini_Boss/Mini_Observation.png" },
        { id: 117, type: 'Mini', name: "Ogretooth", img: "images/Mini_Boss/Mini_Ogretooth.png" },
        { id: 118, type: 'Mini', name: "Skeggiold", img: "images/Mini_Boss/Mini_Skeggiold.png" },
        { id: 119, type: 'Mini', name: "Toad", img: "images/Mini_Boss/Mini_Toad.png" },
        { id: 120, type: 'Mini', name: "Vagabond Wolf", img: "images/Mini_Boss/Mini_Vagabond Wolf.png" },
        { id: 121, type: 'Mini', name: "Sorcerer Celia", img: "images/Mini_Boss/Mini_Sorcerer Celia.png" },
        { id: 122, type: 'Mini', name: "Ktullanux", img: "images/Mini_Boss/Mini_Ktullanux.png" },
        { id: 123, type: 'Mini', name: "Ranger Cecil", img: "images/Mini_Boss/Mini_Ranger Cecil.png" },
        { id: 124, type: 'Mini', name: "Shelter", img: "images/Mini_Boss/Mini_Shelter.png" }
    ];

    const fallbackImage = "https://via.placeholder.com/150x150/cccccc/ffffff?text=No+Img";
    let selectedBoss = null;
    let activeTimers = [];
    let currentTab = 'MVP';

    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');
    function generateRoomId() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
    if (!roomId) { roomId = generateRoomId(); window.location.search = `?room=${roomId}`; }
    document.getElementById('roomInfo').innerHTML = `üîë ‡∏´‡πâ‡∏≠‡∏á: <span class="share-link" onclick="copyLink()">${roomId}</span> <span style="color:#666; font-size:0.9em;">(‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Copy)</span>`;
    function copyLink() { navigator.clipboard.writeText(window.location.href); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß!"); }

    const bossGrid = document.getElementById('bossGrid');
    const searchBox = document.getElementById('searchBox');

    function switchTab(type) {
        currentTab = type;
        document.getElementById('tabMVP').classList.remove('active');
        document.getElementById('tabMini').classList.remove('active');
        document.getElementById(`tab${type}`).classList.add('active');
        if (searchBox.value.trim() === '') renderBosses();
    }

    function renderBosses(filterText = '') {
        bossGrid.innerHTML = '';
        let filteredBosses = bossData.filter(b => (filterText.trim() === '' ? b.type === currentTab : b.name.toLowerCase().includes(filterText.toLowerCase())));
        filteredBosses.forEach(boss => {
            const div = document.createElement('div');
            div.id = `boss-item-${boss.id}`;
            div.className = `boss-item ${selectedBoss?.id === boss.id ? 'selected' : ''}`;
            div.onclick = () => selectBoss(boss);
            div.innerHTML = `<img src="${boss.img}" onerror="this.onerror=null;this.src='${fallbackImage}'">${filterText.trim() !== '' ? `<span class="boss-type-badge type-${boss.type} grid-badge">${boss.type}</span><br>` : ''}<span>${boss.name}</span>`;
            bossGrid.appendChild(div);
        });
    }

    function selectBoss(boss) {
        if (selectedBoss) { const oldDiv = document.getElementById(`boss-item-${selectedBoss.id}`); if (oldDiv) oldDiv.classList.remove('selected'); }
        selectedBoss = boss;
        if (boss.type !== currentTab && searchBox.value.trim() !== '') switchTab(boss.type);
        const newDiv = document.getElementById(`boss-item-${boss.id}`);
        if (newDiv) newDiv.classList.add('selected');
    }
    
    function validateTimeInput(el) { el.value = el.value.replace(/[^0-9]/g, '').slice(0, 2); }
    searchBox.addEventListener('input', (e) => renderBosses(e.target.value));
    renderBosses();

    function addTimerToCloud() {
        if (!selectedBoss) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏≠‡∏™‡∏Å‡πà‡∏≠‡∏ô"); return; }
        const hr = parseInt(document.getElementById('inputHr').value) || 0;
        const min = parseInt(document.getElementById('inputMin').value) || 0;
        const sec = parseInt(document.getElementById('inputSec').value) || 0;
        const totalSeconds = (hr * 3600) + (min * 60) + sec;
        if (totalSeconds <= 0) { alert("‚ö†Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0"); return; }
        const now = new Date().getTime();
        db.ref('rooms/' + roomId + '/timers').push({ bossId: selectedBoss.id, targetTime: now + (totalSeconds * 1000) });
        const currentDiv = document.getElementById(`boss-item-${selectedBoss.id}`);
        if (currentDiv) currentDiv.classList.remove('selected');
        selectedBoss = null;
        document.getElementById('inputHr').value = ''; document.getElementById('inputMin').value = ''; document.getElementById('inputSec').value = '';
    }

    function removeTimerFromCloud(key) { db.ref('rooms/' + roomId + '/timers/' + key).remove(); }

    const mainCardMap = new Map();
    const pipCardMap = new Map();

    db.ref('rooms/' + roomId + '/timers').on('value', (snapshot) => {
        const data = snapshot.val();
        activeTimers = [];
        if (data) {
            Object.keys(data).forEach(key => {
                const item = data[key];
                const bossInfo = bossData.find(b => b.id === item.bossId);
                if (bossInfo) activeTimers.push({ id: key, boss: bossInfo, targetTime: item.targetTime });
            });
        }
        updateTimersDisplay();
    });

    function updateTimersDisplay() {
        const now = Date.now();
        activeTimers.sort((a, b) => a.targetTime - b.targetTime);

        if (pipWindow) {
            document.getElementById('timerList').style.display = 'none';
            document.getElementById('pipActiveMsg').style.display = 'flex';
            const pipContainer = pipWindow.document.getElementById('timerList');
            if (pipContainer) syncContainer(pipContainer, pipCardMap, activeTimers, now);
        } else {
            document.getElementById('timerList').style.display = 'block';
            document.getElementById('pipActiveMsg').style.display = 'none';
            const mainContainer = document.getElementById('timerList');
            if (mainContainer) syncContainer(mainContainer, mainCardMap, activeTimers, now);
        }
    }

    function syncContainer(container, cardMap, timers, now) {
        const activeIds = new Set();
        
        // Smart Sort Check
        const currentOrder = Array.from(container.children).map(n => n.getAttribute('data-id'));
        const newOrder = timers.map(t => t.id);
        const isOrderChanged = JSON.stringify(currentOrder) !== JSON.stringify(newOrder);

        timers.forEach(timer => {
            activeIds.add(timer.id);
            let cardData = cardMap.get(timer.id);

            const distance = timer.targetTime - now;
            let timeString = "", isExpired = false;
            if (distance < 0) { isExpired = true; timeString = "SPAWNED!"; }
            else {
                const h = Math.floor((distance / (1000 * 60 * 60)) % 24);
                const m = Math.floor((distance / (1000 * 60)) % 60);
                const s = Math.floor((distance / 1000) % 60);
                timeString = `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }

            const d = new Date(timer.targetTime);
            const thaiTime = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            let spawnInfoHtml = isExpired ? `<div class="spawn-time-text expired">üî• ‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${thaiTime} ‡∏ô.</div>` : `<div class="spawn-time-text">üïí ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤: ${thaiTime} ‡∏ô.</div>`;

            if (!cardData) {
                const card = document.createElement('div');
                card.className = 'timer-card';
                card.setAttribute('data-id', timer.id);
                card.innerHTML = `
                    <div class="timer-info">
                        <img src="${timer.boss.img}" onerror="this.onerror=null;this.src='${fallbackImage}'">
                        <div class="timer-text">
                            <span class="boss-type-badge type-${timer.boss.type} card-badge">${timer.boss.type}</span>
                            <h3>${timer.boss.name}</h3>
                            <div class="info-wrapper">${spawnInfoHtml}</div>
                        </div>
                    </div>
                    <div class="countdown">${timeString}</div>
                    <button class="btn-delete" onclick="removeTimerFromCloud('${timer.id}')">‚úñ</button>
                `;
                container.appendChild(card);
                cardData = { card: card, countdown: card.querySelector('.countdown'), infoWrapper: card.querySelector('.info-wrapper') };
                cardMap.set(timer.id, cardData);
            }

            // ‡∏ñ‡πâ‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
            if (isOrderChanged) container.appendChild(cardData.card);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (cardData.countdown.innerText !== timeString) cardData.countdown.innerText = timeString;
            
            if(isExpired) {
                cardData.countdown.classList.add('spawned');
                cardData.card.style.borderLeftColor = "#c0392b"; 
                cardData.card.style.backgroundColor = "#fff5f5";
            } else {
                cardData.countdown.classList.remove('spawned');
                cardData.card.style.borderLeftColor = ""; 
                cardData.card.style.backgroundColor = "";
            }
            if(cardData.infoWrapper.innerHTML !== spawnInfoHtml) cardData.infoWrapper.innerHTML = spawnInfoHtml;
        });

        for (const [id, data] of cardMap) {
            if (!activeIds.has(id)) {
                data.card.remove();
                cardMap.delete(id);
            }
        }
    }

    setInterval(updateTimersDisplay, 1000);

    let pipWindow = null;

    async function togglePictureInPicture() {
        if (!('documentPictureInPicture' in window)) { alert("Browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ"); return; }
        if (pipWindow) { pipWindow.close(); return; }

        try {
            // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á/‡∏™‡∏π‡∏á ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PiP
            pipWindow = await documentPictureInPicture.requestWindow({ width: 320, height: 450 });

            [...document.styleSheets].forEach((styleSheet) => {
                try {
                    const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                    const style = document.createElement('style');
                    style.textContent = cssRules;
                    pipWindow.document.head.appendChild(style);
                } catch (e) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.type = styleSheet.type;
                    link.media = styleSheet.media;
                    link.href = styleSheet.href;
                    pipWindow.document.head.appendChild(link);
                }
            });

            const pipTimerContainer = document.createElement('div');
            pipTimerContainer.id = 'timerList'; 
            pipWindow.document.body.append(pipTimerContainer);
            pipWindow.document.body.classList.add('pip-mode');

            updateTimersDisplay();

            pipWindow.addEventListener("pagehide", (event) => {
                pipWindow = null;
                pipCardMap.clear();
            });

        } catch (err) { console.error("Failed to open PiP window:", err); }
    }

    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
    }
</script>

</body>
</html>